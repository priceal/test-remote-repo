<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Two-Layer Climate Model</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; font-family: Arial, sans-serif; }
  canvas { display: block; }
  .controls { margin-top: 14px; display: flex; flex-direction: column; gap: 8px; font-size: 14px; color: #333; width: 420px; }
  .ctrl-row { display: flex; align-items: center; gap: 10px; }
  .ctrl-row label { width: 140px; text-align: right; }
  .ctrl-row input[type=range] { flex: 1; }
  .ctrl-row span { width: 70px; font-variant-numeric: tabular-nums; }
  .info { margin-top: 6px; font-size: 12px; color: #555; text-align: center; line-height: 1.5; }
</style>
</head>
<body>
<canvas id="c"></canvas>
<div class="controls">
  <div class="ctrl-row">
    <label for="solar">Incident V1:</label>
    <input type="range" id="solar" min="40" max="140" value="90">
    <span id="solarVal">90</span>
  </div>
  <div class="ctrl-row">
    <label for="albedo">Albedo (α):</label>
    <input type="range" id="albedo" min="0" max="95" value="30">
    <span id="albedoVal">0.30</span>
  </div>
</div>
<div class="info" id="info"></div>
<script>
const cv = document.getElementById('c');
const ctx = cv.getContext('2d');
const W = 800, H = 650;
cv.width = W; cv.height = H;

const solarSlider = document.getElementById('solar');
const albedoSlider = document.getElementById('albedo');
const solarValEl = document.getElementById('solarVal');
const albedoValEl = document.getElementById('albedoVal');
const infoEl = document.getElementById('info');

function drawArrow(cx, topY, botY, w, color, label, down) {
  if (w < 3) return;
  const headH = 22;
  const headW = Math.min(w * 1.6, w + 36);
  ctx.fillStyle = color;
  if (down) {
    ctx.fillRect(cx - w / 2, topY, w, botY - topY - headH);
    ctx.beginPath();
    ctx.moveTo(cx - headW / 2, botY - headH);
    ctx.lineTo(cx + headW / 2, botY - headH);
    ctx.lineTo(cx, botY);
    ctx.closePath();
    ctx.fill();
  } else {
    ctx.fillRect(cx - w / 2, topY + headH, w, botY - topY - headH);
    ctx.beginPath();
    ctx.moveTo(cx - headW / 2, topY + headH);
    ctx.lineTo(cx + headW / 2, topY + headH);
    ctx.lineTo(cx, topY);
    ctx.closePath();
    ctx.fill();
  }
  if (w > 10 && label) {
    ctx.save();
    const midY = down ? (topY + botY - headH) / 2 : (topY + headH + botY) / 2;
    ctx.translate(cx, midY);
    ctx.rotate(-Math.PI / 2);
    ctx.fillStyle = '#fff';
    const fs = Math.max(9, Math.min(w * 0.35, 18));
    ctx.font = 'bold ' + fs + 'px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(label, 0, 0);
    ctx.restore();
  }
}

function draw() {
  const V1 = +solarSlider.value;
  const alpha = +albedoSlider.value / 100;
  solarValEl.textContent = V1;
  albedoValEl.textContent = alpha.toFixed(2);

  const V2 = alpha * V1;
  const V3 = (1 - alpha) * V1;
  const R1 = (1 - alpha) * V1;
  const R2 = (1 - alpha) * V1;
  const R3 = 2 * (1 - alpha) * V1;

  ctx.clearRect(0, 0, W, H);

  // Geometry
  const blockW = 620;
  const blockH = blockW / 8;
  const bx = (W - blockW) / 2;

  const earthY = H - blockH - 16;
  const arrowLen = 190;
  const atmoY = earthY - arrowLen - blockH; // atmosphere positioned so gap = arrowLen
  const topOfAbove = atmoY - arrowLen;       // top arrows start here

  // Atmosphere block
  ctx.fillStyle = 'rgba(135,206,250,0.55)';
  ctx.fillRect(bx, atmoY, blockW, blockH);
  ctx.strokeStyle = '#5B9BD5';
  ctx.lineWidth = 2;
  ctx.strokeRect(bx, atmoY, blockW, blockH);

  // Earth block
  ctx.fillStyle = '#6B4226';
  ctx.fillRect(bx, earthY, blockW, blockH);

  // Labels on blocks
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';

  ctx.fillStyle = '#1a5276';
  ctx.font = 'bold 16px Arial';
  ctx.fillText('ATMOSPHERE', bx + blockW / 2, atmoY + blockH / 2);

  ctx.fillStyle = '#fff';
  ctx.font = 'bold 16px Arial';
  ctx.fillText('EARTH', bx + blockW * 0.55, earthY + blockH / 2);

  // Temperatures
  const Te = 88.210658 * Math.pow(R3, 0.25);
  const TeCel = Te - 273.15;
  const TeFah = TeCel * 9 / 5 + 32;
  ctx.font = 'bold 14px Arial';
  ctx.fillStyle = '#fff';
  ctx.textAlign = 'left';
  ctx.fillText('T = ' + TeCel.toFixed(1) + ' °C', bx + 10, earthY + blockH / 2 - 8);
  ctx.fillText('T = ' + TeFah.toFixed(1) + ' °F', bx + 10, earthY + blockH / 2 + 10);

  const Ta = 88.210658 * Math.pow(R1, 0.25);
  const TaCel = Ta - 273.15;
  ctx.font = 'bold 13px Arial';
  ctx.fillStyle = '#1a5276';
  ctx.textAlign = 'right';
  ctx.fillText('T = ' + TaCel.toFixed(1) + ' °C', bx + blockW - 10, atmoY + blockH / 2);

  ctx.textAlign = 'center';

  // Arrow regions
  const aboveTop = topOfAbove;
  const aboveBot = atmoY;
  const belowTop = atmoY + blockH;
  const belowBot = earthY;

  // Column positions — 5 columns for all 6 arrows
  // Above: V1(down)  V2(up)  R1(up)
  // Below: V3(down)  R3(up)  R2(down) — R2 directly below R1
  //
  // Layout left to right:
  //   Col A: V1 (above), V3 (below)
  //   Col B: V2 (above)
  //   Col C: R3 (below) — between V3 and R2
  //   Col D: R1 (above), R2 (below) — stacked to show equal width

  const gap = 20;
  // Compute total width needed
  const maxW = Math.max(V1, V2, V3, R1, R2, R3);
  
  const colA = bx + blockW * 0.14;
  const colB = bx + blockW * 0.34;
  const colD = bx + blockW * 0.82;
  // R3 between V3 (colA) and R2 (colD)
  const colC = (colA + colD) / 2;

  // Above atmosphere arrows
  drawArrow(colA, aboveTop, aboveBot, V1, '#F5C518', 'Visible', true);
  drawArrow(colB, aboveTop, aboveBot, V2, '#F5C518', 'Visible', false);
  drawArrow(colD, aboveTop, aboveBot, R1, '#D32F2F', 'IR', false);

  // Below atmosphere arrows
  drawArrow(colA, belowTop, belowBot, V3, '#F5C518', 'Visible', true);
  drawArrow(colC, belowTop, belowBot, R3, '#CC0000', 'IR', false);
  drawArrow(colD, belowTop, belowBot, R2, '#D32F2F', 'IR', true);

  // Top labels
  ctx.font = '11px Arial';
  ctx.fillStyle = '#B8860B';
  ctx.fillText('Solar In', colA, aboveTop - 8);
  if (V2 > 5) { ctx.fillStyle = '#B8860B'; ctx.fillText('Reflected', colB, aboveTop - 8); }
  if (R1 > 5) { ctx.fillStyle = '#D32F2F'; ctx.fillText('IR Out', colD, aboveTop - 8); }

  // Title
  ctx.fillStyle = '#333';
  ctx.font = 'bold 20px Arial';
  ctx.textAlign = 'center';
  ctx.fillText('Two-Layer Climate Model (Block Atmosphere)', W / 2, 22);

  // Info
  infoEl.innerHTML =
    `V1=${V1.toFixed(0)}  |  V2=αV1=${V2.toFixed(1)}  |  V3=(1−α)V1=${V3.toFixed(1)}  |  R1=R2=(1−α)V1=${R1.toFixed(1)}  |  R3=2(1−α)V1=${R3.toFixed(1)}<br>` +
    `Energy check — Top of atmo: V1 = V2+R1 → ${V1.toFixed(1)} = ${(V2 + R1).toFixed(1)} ✓  |  Earth: V3+R2 = R3 → ${(V3 + R2).toFixed(1)} = ${R3.toFixed(1)} ✓`;
}

solarSlider.addEventListener('input', draw);
albedoSlider.addEventListener('input', draw);
draw();
</script>
</body>
</html>
